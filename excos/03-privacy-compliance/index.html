<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  3. Implementing privacy compliance
  #

In the modern internet everyone and their mother is collecting data about users.
And to be fair, I also want to collect some for legitimate reasons - making a better product and a better experience to my users.
But because there&rsquo;s a lot of nefarious actors out there we now have regulations in place that explicitly require services to provide users with more control over their data."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://devblog.dziubiak.pl/excos/03-privacy-compliance/"><meta property="og:site_name" content="Marian's Blog"><meta property="og:title" content="3. Implementing privacy compliance"><meta property="og:description" content="3. Implementing privacy compliance # In the modern internet everyone and their mother is collecting data about users. And to be fair, I also want to collect some for legitimate reasons - making a better product and a better experience to my users. But because thereâ€™s a lot of nefarious actors out there we now have regulations in place that explicitly require services to provide users with more control over their data."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="excos"><meta property="article:modified_time" content="2024-10-26T20:17:43+01:00"><meta property="og:image" content="https://devblog.dziubiak.pl/blog.jpg"><title>3. Implementing privacy compliance | Marian's Blog</title>
<link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://devblog.dziubiak.pl/excos/03-privacy-compliance/><link rel=stylesheet href=/book.min.2d7fec8e866046a7460a1cc86027535586803606a87c87da3098bcd8d5a2b62d.css integrity="sha256-LX/sjoZgRqdGChzIYCdTVYaANgaofIfaMJi82NWiti0=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.e220b5418b3fc5ddd487c3bb8dd43bba5ecd6366ca1bbaeacfb54fdb14948b16.js integrity="sha256-4iC1QYs/xd3Uh8O7jdQ7ul7NY2bKG7rqz7VP2xSUixY=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/manio.png alt=Logo class=book-icon><span>Marian's Blog</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=/excos/>Excos</a><ul><li><a href=/excos/01-simple-cd-pipeline/>1. Simple CI/CD pipeline</a></li><li><a href=/excos/03-privacy-compliance/ class=active>3. Implementing privacy compliance</a></li></ul></li><li><a href=/iqa-management-hub/>IQA Management Hub</a><ul><li><a href=/iqa-management-hub/01-writing-system-tests/>1. Writing system tests</a></li></ul></li><li><a href=/stride/>Stride</a><ul><li><a href=/stride/01-nuget-plugins/>1. Using NuGet packages as plugins</a></li></ul></li><li><a href=/telemetry/>Telemetry</a><ul><li><a href=/telemetry/01-exporting-eventsource-locally/>1. Exporting EventSource logs to CSV</a></li></ul></li><li><a href=/web/>Web</a><ul><li><a href=/web/01-isolated-features/>1. Isolated web features within a single ASP.NET Core service</a></li><li><a href=/web/02-experimentation/>2. Short guide to experimentation</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label><h3>3. Implementing privacy compliance</h3><label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#legitimate-interest--consent>Legitimate interest & Consent</a></li><li><a href=#right-to-be-forgotten>Right to be forgotten</a></li><li><a href=#right-of-access>Right of access</a></li><li><a href=#data-classification>Data classification</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=3-implementing-privacy-compliance>3. Implementing privacy compliance
<a class=anchor href=#3-implementing-privacy-compliance>#</a></h1><p>In the modern internet everyone and their mother is collecting data about users.
And to be fair, I also want to collect some for legitimate reasons - making a better product and a better experience to my users.
But because there&rsquo;s a lot of nefarious actors out there we now have regulations in place that explicitly require services to provide users with more control over their data.</p><p><a href=https://www.cloudflare.com/learning/privacy/what-is-the-gdpr/>GDPR</a> and
<a href=https://www.cloudflare.com/learning/privacy/what-is-eprivacy-directive/>ePrivacy directive</a> are the EU legislation which mandate consumer privacy rights.
Their existence has spawned such services as
<a href=https://plausible.io/blog/legal-assessment-gdpr-eprivacy>Plausible</a> and
<a href=https://umami.is/>Umami</a> which offer compliant web analytics.</p><p>This blog will try to cover how I&rsquo;m looking to implement privacy measures in Excos to comply with GDPR.
Mind you, there&rsquo;s no one way to do things compliantly, so depending on the requirements of your system this approach may or may not be suitable.</p><h2 id=legitimate-interest--consent>Legitimate interest & Consent
<a class=anchor href=#legitimate-interest--consent>#</a></h2><p>When it comes to collecting and processing personal data (which includes anything that could identify an individual) we either need to show that we have a legitimate interest, i.e. the collection is required for what the user is trying to accomplish using the service, or we need to gather consent from the user for the &ldquo;extra&rdquo; data use.</p><p>Excos is a platform providing remote application configuration, experimentation over application telemetry and decision automation.
Collecting user billing details for example would be a legitimate interest to enter into a contract with the user to provide them the services.</p><p>But often we are collecting personal data without the user explicitly providing us with it.
For instance, the country inferred from user&rsquo;s IP address for service telemetry can be considered a personal data point if it&rsquo;s stored next to a user identifier.
And often times we want to know how many unique users we deal with so having some sort of user identifier is necessary to calculate it.</p><p>Do we need to calculate unique users to provide the service? Generally, no.</p><p>So if we want to do processing of personal data that is not the required to provide a service to the user (that they want to be provided), we need to get their consent.
Let&rsquo;s look at the following requirements:</p><blockquote><ul><li>Consent must be freely given, specific, informed and unambiguous.</li><li>The data subject must also be informed about his or her right to withdraw consent anytime.
The withdrawal must be as easy as giving consent.</li><li>The consent must be bound to one or several specified purposes which must then be sufficiently explained.</li><li>Consent cannot be implied and must always be given through an opt-in, a declaration or an active motion.</li><li>The controller is not allowed to switch from the legal basis consent to legitimate interest once the data subject withdraws his consent. This applies even if a valid legitimate interest existed initially. Therefore, consent should always be chosen as a last option for processing personal data.<br><a href=https://gdpr-info.eu/issues/consent/><em>source</em></a></li></ul></blockquote><p>Let&rsquo;s say we&rsquo;re considering the following:</p><ol><li>Collect personal data to provide the service:<ul><li>We store the information on which user made a change to a configuration and we may display this information on the configuration page to other users in the same organization.</li><li>We store the user email address in order to be able to send them a notification they opt-into once the system detects a problem with the user&rsquo;s application.</li></ul></li><li>Collect personal data to allow for debugging and customer support:<ul><li>We store information on the user action in the telemetry so that in case of a system error we can trace back the user steps and reproduce them to understand and fix the issue.</li></ul></li><li>Collect and use telemetry to understand product usage and improve the product:<ul><li>We may collect some extra telemetry to paint a bigger picture of user behavior, which was not needed for debugging only.</li></ul></li><li>Create a user profile for experience personalization:<ul><li>We create a user profile that tells us about their product usage history which we use to alter the user experience via in-app suggestions.</li></ul></li><li>Create a user profile for marketing purposes:<ul><li>We create a user profile in order to target them with marketing messages, such as to upsell freemium users.</li></ul></li><li>Create an audit log for security purposes:<ul><li>We store the user details together with information on when they signed in or accessed a resource in the system. If we detect suspicious activity we may temporarily block the user account.</li></ul></li></ol><p>We want to process as much data under legitimate interest clause as we can.
From what I&rsquo;ve read we can treat 3 of the above as such: 1. provide, 2. debug problems, 6. security.</p><p>Then we would want to collect consent for the other 3 purposes.
Each purpose is treated separately and must be opted-into by the user separately.
For example, using check-boxes on the sign up form and in the user settings (remember about removing consent).</p><p>I&rsquo;m going to create a consent bit-map:</p><ul><li>0 - no consent for non-required data</li><li>1 - consent for product improvement telemetry (<code>I</code>)</li><li>2 - consent for personalization profile (<code>P</code>)</li><li>4 - consent for marketing profile (<code>M</code>)</li></ul><p>The bitmap value will be stored in the user settings and used when initializing the telemetry system, so that we can decide on whether to collect extra telemetry or not.
Moreover, the telemetry will be stamped with the consent information to create evidence of what the user consent was when the data was collected.
The user may later take back consent which means we can no longer process the previously collected data, but it doesn&rsquo;t have to be deleted (immutable telemetry).</p><p>This last bit is important - it means that any time we perform processing we need to know what is the latest consent state.
Since we&rsquo;re tagging all our logs with the consent bitmap, it should be possible to do <code>ARGMAX(time, consent_map)</code> to find out their current preference and filter the rest of the logs accordingly.</p><h2 id=right-to-be-forgotten>Right to be forgotten
<a class=anchor href=#right-to-be-forgotten>#</a></h2><p>Under the GDPR the user has the right to request removal of their personal data.
They can request only specific data to be removed.</p><p>For this purpose we&rsquo;re going to implement the following:</p><ol><li>User has a persistent account ID (<code>puid</code>)<ul><li>This id is used for cases where despite data removal request the data will have to be retained for other legal reasons: e.g. security and billing (within some retention period).</li><li>This id is used for account access, authorization, tenant membership, etc.</li><li>Any identifiable information such as email, name, etc. is stored together with this ID.</li></ul></li><li>User has an operational user ID (<code>oid</code>)<ul><li>This id is used in events and databases to denote actions taken by the user.</li><li>This id is tied to a user alias that they agreed can be shared publicly.</li><li>Upon user closing their account, the connection between their persistent ID and operational ID is severed.</li></ul></li><li>User has at least one telemetry ID (<code>tyid</code>)<ul><li>This id is created by hashing the operational ID with a salt that the user can ask to be rotated, which de-links all previously collected for them telemetry.</li><li>This id is used in all telemetry instead of the operational ID, which preserves unique user semantics and facilitates debugging.</li><li>Upon user closing their account the salt is cleared or rotated.</li></ul></li></ol><p>In order to prevent indirect identification, any other object IDs stored in a way where they can be linked to an operational ID also need to be hashed before being added to telemetry with a tenant level salt.</p><p>User&rsquo;s personal data, except where it needs to be kept for legal reasons should be erased.</p><h2 id=right-of-access>Right of access
<a class=anchor href=#right-of-access>#</a></h2><p>The user has the right to request a copy of all data currently held on them by the system.
They should have an &ldquo;easy&rdquo; way to download their data and they can request it over email or other channels.</p><p>We already are going to have an OData based web API for programmatic access, but we also need a button in the user profile where they can request their data easily.
A database sourced export would cover anything available through the API, but in a simplified user-centric view.
For example we wouldn&rsquo;t export all the configuration fields the user has modified, but only the fact they they modified that specific config.</p><p>Then a second data export would mainly consist of exporting the telemetry.
But we don&rsquo;t need to export all telemetry, but only that pertains to what we know about the user actions.
If a user action results in multiple telemetry events describing the system&rsquo;s internal operations, we only surface to the user the action that they had taken.</p><p>To support this, all telemetry events must be annotated with the information on whether they are exportable or not.
All UX events directly initiated by the user are exportable.</p><p>A data pipeline needs to be put in place where once daily/weekly (depending on the export event volume) it takes all the pending requests and executes a query over the telemetry and the database that reads <strong>all</strong> data we can currently link to the user and puts them into a portable file format the user can open in a blob storage.
The user would be then emailed a secure link to access this file.
After 30 days the file would be deleted.</p><p>In order to prevent abuse, a user cannot issue a new request until the previous one is completed.</p><h2 id=data-classification>Data classification
<a class=anchor href=#data-classification>#</a></h2><p>Dealing with personal data requires us to classify certain data fields to denote that what they contain is personal or can link to personal data.
Further more most debugging activities should not allow us (the host) to view all data the users are managing.
Since this is potentially a B2B service, we wouldn&rsquo;t want to for example see their config names which could leak upcoming features before they are announced.</p><p>As such the data must be classified.
We will leverage this
<a href=https://www.nuget.org/packages/Microsoft.Extensions.Compliance.Redaction/>package</a> to create data classification attributes and ensure any sensitive data is redacted before logging.</p><p>Classification:</p><ul><li>UII - User Identifiable Information<ul><li>This covers any directly identifiable information such as email, name, address, IP address (in some cases)</li></ul></li><li>UPI - User Pseudonymous Identifier<ul><li>This covers any identifier which could be indirectly used to reach UII such as user IDs, session IDs, object IDs (if those objects link to a single specific user ID)</li></ul></li><li>UDI - User Demographic Information<ul><li>This covers any data about the users age group, country of residence, or other demographic elements, which would not identify a single individual if de-linked</li></ul></li><li>CC - Customer Content<ul><li>Any content which the users upload to the system (e.g. config names) which may be sensitive</li></ul></li><li>OI - Organization Information<ul><li>Non personal data related to the tenant (including tenant ID)</li></ul></li><li>SYS - System Metadata<ul><li>Any data which is system specific and would not be considered personal nor can be used to link to personal data on its own (e.g. enums, certain object IDs)</li></ul></li></ul><p>No UII and CC can appear in the logs. Only processed UPIs (appropriately hashed) can appear in logs.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><span class="flex align-center" title='Last modified by Marian Dziubiak | October 26, 2024'><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>Last modified October 26, 2024</span></span></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#legitimate-interest--consent>Legitimate interest & Consent</a></li><li><a href=#right-to-be-forgotten>Right to be forgotten</a></li><li><a href=#right-of-access>Right of access</a></li><li><a href=#data-classification>Data classification</a></li></ul></nav></div></aside></main></body></html>