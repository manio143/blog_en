<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="1. Writing system tests # So here I am - I made a decision to make a rewrite of the service. Where do I start? Well, the number one thing I want to do is to try to follow good practices. I don&rsquo;t want to just write this thing from scratch and swap them out in one go, possibly breaking tens of existing users with something I haven&rsquo;t tested. So I need to first document how the existing service works."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="1. Writing system tests"><meta property="og:description" content="1. Writing system tests # So here I am - I made a decision to make a rewrite of the service. Where do I start? Well, the number one thing I want to do is to try to follow good practices. I don&rsquo;t want to just write this thing from scratch and swap them out in one go, possibly breaking tens of existing users with something I haven&rsquo;t tested. So I need to first document how the existing service works."><meta property="og:type" content="article"><meta property="og:url" content="https://devblog.dziubiak.pl/iqa-management-hub/01-writing-system-tests/"><meta property="og:image" content="https://devblog.dziubiak.pl/iqa-management-hub/01-writing-system-tests.jpg"><meta property="article:section" content="iqa-management-hub"><meta property="article:modified_time" content="2022-11-29T09:13:34+00:00"><title>1. Writing system tests | Marian's Blog</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.4b35fed0bea034bbc19c89c71e14b73fb9c68cfcc586b9382adfb9b7b103ba06.css integrity="sha256-SzX+0L6gNLvBnInHHhS3P7nGjPzFhrk4Kt+5t7EDugY=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script><script defer src=/en.search.min.d38ec361fd083bbce70b42140f9f58552294a216e2598cab53da429d43ce79de.js integrity="sha256-047DYf0IO7znC0IUD59YVSKUohbiWYyrU9pCnUPOed4=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/manio.png alt=Logo><span>Marian's Blog</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/iqa-management-hub/>IQA Management Hub</a><ul><li><a href=/iqa-management-hub/01-writing-system-tests/ class=active>1. Writing system tests</a></li></ul></li><li><a href=/stride/>Stride</a><ul><li><a href=/stride/01-nuget-plugins/>1. Using NuGet packages as plugins</a></li></ul></li><li><a href=/telemetry/>Telemetry</a><ul><li><a href=/telemetry/01-exporting-eventsource-locally/>1. Exporting EventSource logs to CSV</a></li></ul></li><li><a href=/web/>Web</a><ul><li><a href=/web/01-isolated-features/>1. Isolated web features within a single ASP.NET Core service</a></li><li><a href=/web/02-experimentation/>2. Short guide to experimentation</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>1. Writing system tests</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#what-are-system-tests>What are system tests?</a><ul><li><a href=#setup>Setup</a></li></ul></li><li><a href=#httpclient>HttpClient</a><ul><li><a href=#cookies>Cookies</a></li><li><a href=#redirects>Redirects</a></li><li><a href=#configuring-the-httpclient>Configuring the HttpClient</a></li></ul></li><li><a href=#emails>Emails</a></li><li><a href=#unique-persistent-users>Unique persistent users</a></li></ul></nav></aside></header><article class=markdown><h1 id=1-writing-system-tests>1. Writing system tests
<a class=anchor href=#1-writing-system-tests>#</a></h1><p>So here I am - I made a decision to make a rewrite of the service.
Where do I start? Well, the number one thing I want to do is to try to follow good practices.
I don&rsquo;t want to just write this thing from scratch and swap them out in one go, possibly breaking tens of existing users with something I haven&rsquo;t tested.
So I need to first document how the existing service works.
I will use system tests for that.</p><h2 id=what-are-system-tests>What are system tests?
<a class=anchor href=#what-are-system-tests>#</a></h2><p>If you heard about the
<a href=https://martinfowler.com/articles/practical-test-pyramid.html>test pyramid</a>
you may be familiar with service or integration tests.
The way I define system tests is an external testing process making calls to a locally deployed application and validating the general behavior.</p><p>What this means is that the system test mostly doesn&rsquo;t care about implementation details and focuses on externalities.
For a web API that means most tests should be performable by making HTTP requests against the service.
In my case because I need to document a bit deeper how the service behaves I will also be connecting to the database to inspect it, clean up state created with the tests, etc.</p><h3 id=setup>Setup
<a class=anchor href=#setup>#</a></h3><p>I&rsquo;ve created a new .NET 6 project with the XUnit template and added
<a href=https://github.com/pengweiqhca/Xunit.DependencyInjection>Xunit.DependencyInjection</a>
which allows me to use dependency injection, configuration files and advanced logging controls.</p><p>I&rsquo;ve also created a project for models and generated classes using Entity Framework Core
<a href=https://learn.microsoft.com/en-us/ef/core/cli/dotnet>dotnet tool</a>.
The app uses postgres so I installed <code>Npgsql.EntityFrameworkCore.PostgreSQL</code>.
Then I ran <code>dotnet ef dbcontext scaffold</code> to set up the models.
I like to keep models mostly pure, so all my EF configuration ends up in the DbContext class.</p><p>Finally I needed some tools for making the HTTP requests and I opted for writing my own, specifically tailored to this app.</p><h2 id=httpclient>HttpClient
<a class=anchor href=#httpclient>#</a></h2><p>I have read a lot in the past on how to use the <code>HttpClient</code>.
The most recent advice says to use <code>IHttpClientFactory</code> from the <code>Microsoft.Extensions.Http</code> package.
It allows us to use dependency injection to configure the client.
And you can name the client to have multiple configurations.</p><p>But the main benefit is that the factory intelligently caches the <code>HttpClientHandler</code> instances which hold system resources.
A big issue of manual handler management is port exhaustion when you create to many instances.
It&rsquo;s a general issue and I&rsquo;ve seen systems die from this.</p><p>In .NET Core a new system of layers has been designed on top of the <code>HttpClientHandler</code>.
There&rsquo;s many small and reusable instances of <code>DelegatingHandler</code> which act very similarly to ASP.NET middleware.
It can be used for injecting headers or otherwise modifying the request or the response.</p><h3 id=cookies>Cookies
<a class=anchor href=#cookies>#</a></h3><p>For accessing the management hub website you login with an email and a password and get a session cookie.
Standard stuff. Took me 2 days to make it work.</p><p>So the first thing is cookies.
As mentioned above, the <code>HttpClientHandler</code> is reused by multiple <code>HttpClient</code> instances to save on system resources.
This means that the built in cookie management mechanism are out the window, because they&rsquo;d be shared across multiple clients.
We need the cookie store to be specific to a given test.
Also we need to allow tests to run in parallel for fast CI times later on.</p><p>So I looked around and came up with this middleware
(shout out to
<a href=https://gist.github.com/damianh/038195c1ab0c5013ad3883d7e3c59d99>damianh&rsquo;s gist</a> which saved me from parsing cookies by hand)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>/// &lt;summary&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// Message handler which substitutes the handling of cookies of the &lt;see cref=&#34;HttpClientHandler&#34;/&gt;.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// It allows to reuse a single instance of a underlying handler across multiple cookie sessions.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// &lt;/summary&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CookieSessionMessageHandler</span> : DelegatingHandler
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>readonly</span> HttpRequestOptionsKey&lt;CookieContainer&gt; CookieContainerOption
</span></span><span style=display:flex><span>        = <span style=color:#66d9ef>new</span>(<span style=color:#e6db74>&#34;CookieContainer&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>async</span> Task&lt;HttpResponseMessage&gt; SendAsync(
</span></span><span style=display:flex><span>        HttpRequestMessage request,
</span></span><span style=display:flex><span>        CancellationToken cancellationToken)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (!request.Options.TryGetValue(CookieContainerOption, <span style=color:#66d9ef>out</span> <span style=color:#66d9ef>var</span> cookieContainer))
</span></span><span style=display:flex><span>		    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>base</span>.SendAsync(request, cancellationToken);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (cookieContainer.Count &gt; <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>            request.Headers.Add(<span style=color:#e6db74>&#34;Cookie&#34;</span>, cookieContainer.GetCookieHeader(request.RequestUri!));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> response = <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>base</span>.SendAsync(request, cancellationToken);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (response.Headers.TryGetValues(<span style=color:#e6db74>&#34;Set-Cookie&#34;</span>, <span style=color:#66d9ef>out</span> <span style=color:#66d9ef>var</span> cookieValues))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>foreach</span> (<span style=color:#66d9ef>var</span> cookieValue <span style=color:#66d9ef>in</span> cookieValues)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                cookieContainer.SetCookies(request.RequestUri!, cookieValue);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I&rsquo;ve cleaned up the code a bit for this post to keep it shorter, but I also have some debug logs in there.</p><p>We can see I&rsquo;m using the <code>HttpRequestOptions</code> collection to store the <code>CookieContainer</code>.
This means I needed to write custom extensions over <code>HttpClient</code> for things like <code>GetStringAsync()</code>,
because I wanted to build my own <code>HttpRequestMessage</code> and add the cookie container.</p><p>The middleware also works if we don&rsquo;t care about cookies - this is generally a good practice -
make your middleware opt-in rather than opt-out.</p><p>For sending the cookies we&rsquo;re using a method of the <code>CookieContainer</code> called <code>GetCookieHeader(url)</code>.
For saving new cookies we&rsquo;re using the <code>SetCookies(url, cookieHeader)</code> method.
If you happen to have issues with it, checkout the helper class <code>SetCookieHeaderValue</code>, from <code>Microsoft.Net.Http.Headers</code> package, to parse the headers.</p><p>So with this cookie middleware I was able to log in, but afterwards something wasn&rsquo;t working and I had to debug it.</p><h3 id=redirects>Redirects
<a class=anchor href=#redirects>#</a></h3><p>The session cookie system of Rails works in a way that sends a new cookie with each request.
I believe it&rsquo;s meant to prevent an attacker from stealing a session in some way (see
<a href=https://guides.rubyonrails.org/security.html#sessions>Rails guide on security</a>).</p><p>With this new cookie middleware I was sending redirect requests with the same cookie as the original request.</p><script src=/mermaid.min.js></script><script>mermaid.initialize({flowchart:{useMaxWidth:!0},theme:"dark"})</script><p class=mermaid>sequenceDiagram
CookieMiddleware->>HttpClientHandler: Headers["Cookie"]
HttpClientHandler->>Website: HTTP request
Website-->>HttpClientHandler: 302 Headers["Location"]
HttpClientHandler->>Website: HTTP GET request to new location
Website-->>HttpClientHandler: 200 OK
HttpClientHandler-->>CookieMiddleware: Headers["Set-Cookie"]</p><p>And this wasn&rsquo;t working, so I had to write my own redirect layer on top of it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>/// &lt;summary&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// Message handler which substitutes the handling of redirects of the &lt;see cref=&#34;HttpClientHandler&#34;/&gt;.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// We needed redirection layer on top of the custom cookie middleware.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// &lt;/summary&gt; </span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FollowRedirectsMessageHandler</span> : DelegatingHandler
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>async</span> Task&lt;HttpResponseMessage&gt; SendAsync(
</span></span><span style=display:flex><span>        HttpRequestMessage request,
</span></span><span style=display:flex><span>        CancellationToken cancellationToken)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> response = <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>base</span>.SendAsync(request, cancellationToken);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (response.Headers.TryGetValues(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#66d9ef>out</span> <span style=color:#66d9ef>var</span> locations))
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>var</span> redirectRequest = <span style=color:#66d9ef>new</span> HttpRequestMessage(HttpMethod.Get, locations.First());
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (request.Options <span style=color:#66d9ef>is</span> IDictionary&lt;<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>object?</span>&gt; requestOptions &amp;&amp;
</span></span><span style=display:flex><span>			    redirectRequest.Options <span style=color:#66d9ef>is</span> IDictionary&lt;<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>object?</span>&gt; newOptions)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>foreach</span> (<span style=color:#66d9ef>var</span> kvp <span style=color:#66d9ef>in</span> requestOptions)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    newOptions.Add(kvp.Key, kvp.Value);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.SendAsync(redirectRequest, cancellationToken);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> response;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Basically whenever there&rsquo;s a Location header present we make a new request there and copy all the request options.
Note how I used <code>base.SendAsync</code> and <code>this.SendAsync</code> to go directly down the request pipeline or call this method recursively to allow for following multiple redirects.</p><p class=mermaid>sequenceDiagram
RequestMiddleware->>CookieMiddleware: .
CookieMiddleware->>HttpClientHandler: Headers["Cookie"]
HttpClientHandler->>Website: HTTP request
Website-->>HttpClientHandler: 302 Headers["Location"]
HttpClientHandler-->>CookieMiddleware: Headers["Set-Cookie"]
CookieMiddleware-->>RequestMiddleware: .
RequestMiddleware->>CookieMiddleware: GET redirected
CookieMiddleware->>HttpClientHandler: Headers["Cookie"]
HttpClientHandler->>Website: HTTP request</p><h3 id=configuring-the-httpclient>Configuring the HttpClient
<a class=anchor href=#configuring-the-httpclient>#</a></h3><p>Finally we go to the <code>Configure</code> method to set up dependency injection.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>services.AddTransient&lt;FollowRedirectsMessageHandler&gt;();
</span></span><span style=display:flex><span>services.AddTransient&lt;CookieSessionMessageHandler&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>services.AddHttpClient(RequestBuilder.HttpClientName)
</span></span><span style=display:flex><span>.ConfigurePrimaryHttpMessageHandler(() =&gt; <span style=color:#66d9ef>new</span> HttpClientHandler
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    AllowAutoRedirect = <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    UseCookies = <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#75715e>// Ordering of the handlers is important, from top (outermost) to bottom</span>
</span></span><span style=display:flex><span>.AddHttpMessageHandler&lt;FollowRedirectsMessageHandler&gt;()
</span></span><span style=display:flex><span>.AddHttpMessageHandler&lt;CookieSessionMessageHandler&gt;();
</span></span></code></pre></div><p>We disable redirects and cookies on the <code>HttpClientHandler</code> because we add middleware to handle it instead.</p><h2 id=emails>Emails
<a class=anchor href=#emails>#</a></h2><p>Nowadays it feels like emails are a bit of a thing of the past, but at the same time they are everywhere.
Products like SendGrid enable you to make a HTTP request to their server and they take care of sending the email.
But without modern solutions it is still possible to send email over the basic SMTP protocol.
And that is exactly what Management Hub is doing.</p><p>Usually you could write the email to memory or the file system for testing.
But to have additional confidence in my system I want to make sure the mailing library I use is able to send the email properly over SMTP.</p><p>So in my tests I included the library
<a href=https://github.com/cmendible/netDumbster>netDumbster</a> - a simple SMTP server, which allows me to receive emails sent by the web service. In order to not have to run my tests with admin privileges I configured both the service and the library to work on port 4025.</p><p>I&rsquo;ve used the <code>IHostedService</code> interface on my wrapper around the SMTP server to start it once for the whole testing process.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>services.AddSingleton&lt;EmailProvider&gt;();
</span></span><span style=display:flex><span><span style=color:#75715e>// auto-start email server</span>
</span></span><span style=display:flex><span>services.AddSingleton&lt;IHostedService&gt;(sp =&gt; sp.GetRequiredService&lt;EmailProvider&gt;());
</span></span></code></pre></div><p>Then the test receives the wrapper from the DI framework and checks the incoming messages (in a polling fashion in case there&rsquo;s a delay between HTTP response and email being sent) for the one matching a predicate.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;SmtpMessage&gt; PollAsync(Func&lt;SmtpMessage, <span style=color:#66d9ef>bool</span>&gt; predicate, TimeSpan? timeout = <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    timeout ??= TimeSpan.FromSeconds(<span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> var cts = <span style=color:#66d9ef>new</span> CancellationTokenSource(timeout.Value);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Assert.False(cts.Token.IsCancellationRequested, <span style=color:#e6db74>&#34;Smtp polling timeout&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> message = <span style=color:#66d9ef>this</span>.emailMessages.SingleOrDefault(predicate);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (message != <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> message;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> Task.Delay(PollingInterval);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=unique-persistent-users>Unique persistent users
<a class=anchor href=#unique-persistent-users>#</a></h2><p>As I started writing the tests I decided it&rsquo;s a good idea to have each test go through a full cycle of setup, assertion and cleanup.
This means creating a new user, setting up new objects in the database, executing some actions, and finally removing all created things from the database.
I found it an issue to give all tests the same email address, because they can run in parallel and I wouldn&rsquo;t want them to mess with one another.
But random ids are also bad, because they can lead a test to fail some of the time if a bad id is causing an issue.
Or in my case, if a test fails and there&rsquo;s a bug in the cleanup code, having a persistent id can help execute the cleanup at the beginning of the next test run.</p><p>I used a simple mechanism of having a helper method which takes a string argument with <code>[CallerMemberName]</code> which is the name of the test method, an integer seed (in case one test needs multiple users) and returns a user context object, which implements <code>IDisposable</code> to perform cleanup.</p><p>From the name of the method I calculate a stable hash (don&rsquo;t use <code>GetHashCode</code> - it is stable only within a single run) using the <code>FarmHash64</code> algorithm from
<a href=https://github.com/TommasoBelluzzo/FastHashes/>FastHashes</a> and converting the result to a Base64 string (which makes a valid email username).
Also needed to cast the email <code>ToLower()</code> because the service was configured with case insensitive email comparisons.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>string</span> GenerateEmailFromString(<span style=color:#66d9ef>string</span> input, <span style=color:#66d9ef>int</span> seed = <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> inputAsByteSpan = MemoryMarshal.Cast&lt;<span style=color:#66d9ef>char</span>, <span style=color:#66d9ef>byte</span>&gt;(input.AsSpan());
</span></span><span style=display:flex><span>    <span style=color:#75715e>// We&#39;re using a stable hashing algorithm here to ensure</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// the same email is use for a given test between runs</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> hash = Convert.ToBase64String(HashAlgorithm.ComputeHash(inputAsByteSpan));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> seedStr = seed != <span style=color:#ae81ff>0</span> ? seed.ToString() : <span style=color:#66d9ef>string</span>.Empty;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Need to call ToLower, because Devise is doing that before saving the email to the database</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>$&#34;user_{hash.ToLowerInvariant()}{seedStr}@example.com&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><span class="flex align-center" title='Last modified by Marian Dziubiak | November 29, 2022'><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>Last modified November 29, 2022</span></span></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#what-are-system-tests>What are system tests?</a><ul><li><a href=#setup>Setup</a></li></ul></li><li><a href=#httpclient>HttpClient</a><ul><li><a href=#cookies>Cookies</a></li><li><a href=#redirects>Redirects</a></li><li><a href=#configuring-the-httpclient>Configuring the HttpClient</a></li></ul></li><li><a href=#emails>Emails</a></li><li><a href=#unique-persistent-users>Unique persistent users</a></li></ul></nav></div></aside></main></body></html>